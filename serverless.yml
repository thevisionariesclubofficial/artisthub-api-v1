org: thevisionariesclub
service: artisthub-api-v1

provider:
  name: aws
  runtime: nodejs20.x
  stage: ${opt:stage, 'dev'}
  region: ${opt:region, 'ap-south-1'}
  memorySize: 256
  logRetentionInDays: ${self:custom.logRetention.${self:provider.stage}, 7}
  timeout: 30
  versionFunctions: true
  environment:
    REGION: ${self:provider.region}
    STAGE: ${self:provider.stage}
    SERVICE_NAME: ${self:service}
    USERS_TABLE: !Ref UsersTable
    CASTING_TABLE: !Ref CastingTable
    USER_POOL_CLIENT_ID: !Ref CognitoUserPoolClient
    USER_POOL_ID: !Ref CognitoUserPool
  iam:
    role:
      statements:
        - Effect: Allow
          Action:
            - logs:CreateLogGroup
            - logs:CreateLogStream
            - logs:PutLogEvents
          Resource: "arn:aws:logs:${self:provider.region}:*:*"
  httpApi:
    cors:
      allowedOrigins:
        - ${self:custom.corsOrigins.${self:provider.stage}}
      allowedHeaders:
        - Content-Type
        - X-Amz-Date
        - Authorization
        - X-Api-Key
        - X-Amz-Security-Token
        - X-Amz-User-Agent
      allowedMethods:
        - GET
        - POST
        - PUT
        - DELETE
        - PATCH
        - OPTIONS
      maxAge: 86400
    authorizers:
      jwtAuthorizer:
        identitySource: $request.header.Authorization
        issuerUrl: !Join ['', [
          'https://cognito-idp.',
          '${self:provider.region}',
          '.amazonaws.com/',
          '${self:custom.cognito.userPoolId}'
        ]]
        audience:
          - ${self:custom.cognito.userPoolClientId}
        unauthorizedCacheTimeInSeconds: 300

functions:
  signUp:
    handler: src/handlers/auth.signUp
    iamRoleStatements:
      - Effect: Allow
        Action:
          - cognito-idp:SignUp
        Resource: !GetAtt CognitoUserPool.Arn
    events:
      - httpApi:
          path: /auth/signup
          method: post

  signIn:
    handler: src/handlers/auth.signIn
    iamRoleStatements:
      - Effect: Allow
        Action:
          - cognito-idp:InitiateAuth
        Resource: !GetAtt CognitoUserPool.Arn
    events:
      - httpApi:
          path: /auth/login
          method: post

  confirmSignUp:
    handler: src/handlers/auth.confirmSignUp
    iamRoleStatements:
      - Effect: Allow
        Action:
          - cognito-idp:ConfirmSignUp
        Resource: !GetAtt CognitoUserPool.Arn
    events:
      - httpApi:
          path: /auth/confirm
          method: post

  resendConfirmationCode:
    handler: src/handlers/auth.resendConfirmationCode
    iamRoleStatements:
      - Effect: Allow
        Action:
          - cognito-idp:ResendConfirmationCode
        Resource: !GetAtt CognitoUserPool.Arn
    events:
      - httpApi:
          path: /auth/resend-code
          method: post

  adminConfirmUser:
    handler: src/handlers/auth.adminConfirmUser
    iamRoleStatements:
      - Effect: Allow
        Action:
          - cognito-idp:AdminConfirmSignUp
        Resource: !GetAtt CognitoUserPool.Arn
    environment:
      USER_POOL_ID: !Ref CognitoUserPool
    events:
      - httpApi:
          path: /auth/admin-confirm
          method: post

  forgotPassword:
    handler: src/handlers/auth.forgotPassword
    iamRoleStatements:
      - Effect: Allow
        Action:
          - cognito-idp:ForgotPassword
        Resource: !GetAtt CognitoUserPool.Arn
    events:
      - httpApi:
          path: /auth/forgot-password
          method: post

  resetPassword:
    handler: src/handlers/auth.resetPassword
    iamRoleStatements:
      - Effect: Allow
        Action:
          - cognito-idp:ConfirmForgotPassword
        Resource: !GetAtt CognitoUserPool.Arn
    events:
      - httpApi:
          path: /auth/reset-password
          method: post

  createUser:
    handler: src/handlers/user.createUser
    iamRoleStatements:
      - Effect: Allow
        Action:
          - dynamodb:PutItem
          - dynamodb:Query
        Resource: 
          - !GetAtt UsersTable.Arn
          - !Sub '${UsersTable.Arn}/index/usernameIndex'
    events:
      - httpApi:
          path: /users
          method: post
          authorizer: jwtAuthorizer

  getUserById:
    handler: src/handlers/user.getUserById
    iamRoleStatements:
      - Effect: Allow
        Action:
          - dynamodb:GetItem
        Resource: !GetAtt UsersTable.Arn
    events:
      - httpApi:
          path: /users/{userId}
          method: get
          authorizer: jwtAuthorizer

  getUserByUsername:
    handler: src/handlers/user.getUserByUsername
    iamRoleStatements:
      - Effect: Allow
        Action:
          - dynamodb:Query
        Resource:
          - !GetAtt UsersTable.Arn
          - !Sub '${UsersTable.Arn}/index/usernameIndex'
    events:
      - httpApi:
          path: /users/username/{username}
          method: get
          authorizer: jwtAuthorizer

  updateUser:
    handler: src/handlers/user.updateUser
    iamRoleStatements:
      - Effect: Allow
        Action:
          - dynamodb:UpdateItem
          - dynamodb:GetItem
          - dynamodb:Query
        Resource:
          - !GetAtt UsersTable.Arn
          - !Sub '${UsersTable.Arn}/index/usernameIndex'
    events:
      - httpApi:
          path: /users/{userId}
          method: put
          authorizer: jwtAuthorizer

  deleteUser:
    handler: src/handlers/user.deleteUser
    iamRoleStatements:
      - Effect: Allow
        Action:
          - dynamodb:DeleteItem
          - dynamodb:GetItem
        Resource: !GetAtt UsersTable.Arn
    events:
      - httpApi:
          path: /users/{userId}
          method: delete
          authorizer: jwtAuthorizer

  listUsers:
    handler: src/handlers/user.listUsers
    iamRoleStatements:
      - Effect: Allow
        Action:
          - dynamodb:Scan
        Resource: !GetAtt UsersTable.Arn
    events:
      - httpApi:
          path: /users
          method: get
          authorizer: jwtAuthorizer

  incrementUserView:
    handler: src/handlers/user.incrementUserView
    iamRoleStatements:
      - Effect: Allow
        Action:
          - dynamodb:UpdateItem
        Resource: !GetAtt UsersTable.Arn
    events:
      - httpApi:
          path: /users/{userId}/view
          method: put
          authorizer: jwtAuthorizer

  addWorkExperience:
    handler: src/handlers/user.addWorkExperience
    iamRoleStatements:
      - Effect: Allow
        Action:
          - dynamodb:UpdateItem
          - dynamodb:GetItem
        Resource: !GetAtt UsersTable.Arn
    events:
      - httpApi:
          path: /users/{userId}/work-experience
          method: post
          authorizer: jwtAuthorizer

  addPortfolioItem:
    handler: src/handlers/user.addPortfolioItem
    iamRoleStatements:
      - Effect: Allow
        Action:
          - dynamodb:UpdateItem
          - dynamodb:GetItem
        Resource: !GetAtt UsersTable.Arn
    events:
      - httpApi:
          path: /users/{userId}/portfolio
          method: post
          authorizer: jwtAuthorizer

  addConnection:
    handler: src/handlers/user.addConnection
    iamRoleStatements:
      - Effect: Allow
        Action:
          - dynamodb:UpdateItem
          - dynamodb:GetItem
        Resource: !GetAtt UsersTable.Arn
    events:
      - httpApi:
          path: /users/{userId}/connections
          method: post
          authorizer: jwtAuthorizer

  searchUsers:
    handler: src/handlers/user.searchUsers
    iamRoleStatements:
      - Effect: Allow
        Action:
          - dynamodb:Scan
        Resource: !GetAtt UsersTable.Arn
    events:
      - httpApi:
          path: /users/search
          method: get
          authorizer: jwtAuthorizer

  createJob:
    handler: src/handlers/casting.createJob
    iamRoleStatements:
      - Effect: Allow
        Action:
          - dynamodb:PutItem
        Resource: !GetAtt CastingTable.Arn
    events:
      - httpApi:
          path: /casting
          method: post

  getJobById:
    handler: src/handlers/casting.getJobById
    iamRoleStatements:
      - Effect: Allow
        Action:
          - dynamodb:GetItem
        Resource: !GetAtt CastingTable.Arn
    events:
      - httpApi:
          path: /casting/{jobId}
          method: get

  listJobs:
    handler: src/handlers/casting.listJobs
    iamRoleStatements:
      - Effect: Allow
        Action:
          - dynamodb:Scan
        Resource: !GetAtt CastingTable.Arn
    events:
      - httpApi:
          path: /casting
          method: get

  updateJob:
    handler: src/handlers/casting.updateJob
    iamRoleStatements:
      - Effect: Allow
        Action:
          - dynamodb:UpdateItem
          - dynamodb:GetItem
        Resource: !GetAtt CastingTable.Arn
    events:
      - httpApi:
          path: /casting/{jobId}
          method: put

  deleteJob:
    handler: src/handlers/casting.deleteJob
    iamRoleStatements:
      - Effect: Allow
        Action:
          - dynamodb:DeleteItem
          - dynamodb:GetItem
        Resource: !GetAtt CastingTable.Arn
    events:
      - httpApi:
          path: /casting/{jobId}
          method: delete

  applyForJob:
    handler: src/handlers/casting.applyForJob
    iamRoleStatements:
      - Effect: Allow
        Action:
          - dynamodb:UpdateItem
          - dynamodb:GetItem
        Resource: !GetAtt CastingTable.Arn
    events:
      - httpApi:
          path: /casting/{jobId}/apply
          method: post

  getJobApplications:
    handler: src/handlers/casting.getJobApplications
    iamRoleStatements:
      - Effect: Allow
        Action:
          - dynamodb:GetItem
        Resource: !GetAtt CastingTable.Arn
    events:
      - httpApi:
          path: /casting/{jobId}/applications
          method: get

  updateApplicationStatus:
    handler: src/handlers/casting.updateApplicationStatus
    iamRoleStatements:
      - Effect: Allow
        Action:
          - dynamodb:UpdateItem
          - dynamodb:GetItem
        Resource: !GetAtt CastingTable.Arn
    events:
      - httpApi:
          path: /casting/{jobId}/applications/{userId}
          method: put

  incrementJobView:
    handler: src/handlers/casting.incrementJobView
    iamRoleStatements:
      - Effect: Allow
        Action:
          - dynamodb:UpdateItem
        Resource: !GetAtt CastingTable.Arn
    events:
      - httpApi:
          path: /casting/{jobId}/view
          method: put

  addDocument:
    handler: src/handlers/casting.addDocument
    iamRoleStatements:
      - Effect: Allow
        Action:
          - dynamodb:UpdateItem
          - dynamodb:GetItem
        Resource: !GetAtt CastingTable.Arn
    events:
      - httpApi:
          path: /casting/{jobId}/documents
          method: post

  removeDocument:
    handler: src/handlers/casting.removeDocument
    iamRoleStatements:
      - Effect: Allow
        Action:
          - dynamodb:UpdateItem
          - dynamodb:GetItem
        Resource: !GetAtt CastingTable.Arn
    events:
      - httpApi:
          path: /casting/{jobId}/documents/{docId}
          method: delete

  getUserApplications:
    handler: src/handlers/casting.getUserApplications
    iamRoleStatements:
      - Effect: Allow
        Action:
          - dynamodb:Scan
        Resource: !GetAtt CastingTable.Arn
    events:
      - httpApi:
          path: /casting/user/{userId}/applications
          method: get

  searchJobs:
    handler: src/handlers/casting.searchJobs
    iamRoleStatements:
      - Effect: Allow
        Action:
          - dynamodb:Scan
        Resource: !GetAtt CastingTable.Arn
    events:
      - httpApi:
          path: /casting/search
          method: get

resources:
  Resources:
    UsersTable:
      ${file(resources/Users.yaml):UsersTable}
    CastingTable:
      ${file(resources/Casting.yaml):CastingTable}
    CognitoUserPool: 
      ${file(resources/Cognito.yaml):CognitoUserPool}
    CognitoUserPoolClient: 
      ${file(resources/Cognito.yaml):CognitoUserPoolClient}
    CognitoUserPoolDomain: 
      ${file(resources/Cognito.yaml):CognitoUserPoolDomain}
  Outputs:
    UsersTableName:
      Description: Users DynamoDB Table Name
      Value: !Ref UsersTable
      Export:
        Name: ${self:service}-UsersTable-${self:provider.stage}
    CastingTableName:
      Description: Casting DynamoDB Table Name
      Value: !Ref CastingTable
      Export:
        Name: ${self:service}-CastingTable-${self:provider.stage}
    UserPoolId:
      Description: Cognito User Pool ID
      Value: !Ref CognitoUserPool
      Export:
        Name: ${self:service}-UserPoolId-${self:provider.stage}
    UserPoolClientId:
      Description: Cognito User Pool Client ID
      Value: !Ref CognitoUserPoolClient
      Export:
        Name: ${self:service}-UserPoolClientId-${self:provider.stage}
    ApiEndpoint:
      Description: API Gateway Endpoint
      Value: !Sub 'https://${HttpApi}.execute-api.${AWS::Region}.amazonaws.com'
      Export:
        Name: ${self:service}-ApiEndpoint-${self:provider.stage}

custom:
  logRetention:
    dev: 7
    staging: 14
    prod: 30
  pitr:
    dev: false
    staging: true
    prod: true
  corsOrigins:
    dev: '*'
    staging: 'https://staging.artisthub.local'
    prod: 'https://artisthub.com'
  callbackUrls:
    dev: 'http://localhost:3000/auth/callback'
    staging: 'https://staging.artisthub.local/auth/callback'
    prod: 'https://artisthub.com/auth/callback'
  logoutUrls:
    dev: 'http://localhost:3000'
    staging: 'https://staging.artisthub.local'
    prod: 'https://artisthub.com'
  cognito:
    userPoolId: !Ref CognitoUserPool
    userPoolClientId: !Ref CognitoUserPoolClient