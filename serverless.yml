org: thevisionariesclub
service: artisthub-api-v1

provider:
  name: aws
  runtime: nodejs20.x
  stage: ${opt:stage, 'dev'}
  region: ${opt:region, 'ap-south-1'}
  memorySize: 128
  logRetentionInDays: 1
  timeout: 30
  environment:
    REGION: ${self:provider.region}
    USERS_TABLE: !Ref UsersTable
    CASTING_TABLE: !Ref CastingTable
    USER_POOL_CLIENT_ID: !Ref CognitoUserPoolClient
  httpApi:
    authorizers:
      jwtAuthorizer:
        type: jwt
        identitySource: $request.header.Authorization
        issuerUrl: !Join ['', [
          'https://cognito-idp.',
          '${self:provider.region}',
          '.amazonaws.com/',
          '${self:custom.cognito.userPoolId}'
        ]]
        audience:
          - ${self:custom.cognito.userPoolClientId}

functions:
  signUp:
    handler: src/handlers/auth.signUp
    iamRoleStatements:
      - Effect: Allow
        Action:
          - cognito-idp:SignUp
        Resource: !GetAtt CognitoUserPool.Arn
    events:
      - httpApi:
          path: /auth/signup
          method: post
          cors: true

  signIn:
    handler: src/handlers/auth.signIn
    iamRoleStatements:
      - Effect: Allow
        Action:
          - cognito-idp:InitiateAuth
        Resource: !GetAtt CognitoUserPool.Arn
    events:
      - httpApi:
          path: /auth/login
          method: post
          cors: true

  confirmSignUp:
    handler: src/handlers/auth.confirmSignUp
    iamRoleStatements:
      - Effect: Allow
        Action:
          - cognito-idp:ConfirmSignUp
        Resource: !GetAtt CognitoUserPool.Arn
    events:
      - httpApi:
          path: /auth/confirm
          method: post
          cors: true

  resendConfirmationCode:
    handler: src/handlers/auth.resendConfirmationCode
    iamRoleStatements:
      - Effect: Allow
        Action:
          - cognito-idp:ResendConfirmationCode
        Resource: !GetAtt CognitoUserPool.Arn
    events:
      - httpApi:
          path: /auth/resend-code
          method: post
          cors: true

  adminConfirmUser:
    handler: src/handlers/auth.adminConfirmUser
    iamRoleStatements:
      - Effect: Allow
        Action:
          - cognito-idp:AdminConfirmSignUp
        Resource: !GetAtt CognitoUserPool.Arn
    environment:
      USER_POOL_ID: !Ref CognitoUserPool
    events:
      - httpApi:
          path: /auth/admin-confirm
          method: post
          cors: true

  forgotPassword:
    handler: src/handlers/auth.forgotPassword
    iamRoleStatements:
      - Effect: Allow
        Action:
          - cognito-idp:ForgotPassword
        Resource: !GetAtt CognitoUserPool.Arn
    events:
      - httpApi:
          path: /auth/forgot-password
          method: post
          cors: true

  resetPassword:
    handler: src/handlers/auth.resetPassword
    iamRoleStatements:
      - Effect: Allow
        Action:
          - cognito-idp:ConfirmForgotPassword
        Resource: !GetAtt CognitoUserPool.Arn
    events:
      - httpApi:
          path: /auth/reset-password
          method: post
          cors: true

  createUser:
    handler: src/handlers/user.createUser
    iamRoleStatements:
      - Effect: Allow
        Action:
          - dynamodb:PutItem
          - dynamodb:Query
        Resource: 
          - !GetAtt UsersTable.Arn
          - !Sub '${UsersTable.Arn}/index/usernameIndex'
    events:
      - httpApi:
          path: /users
          method: post
          cors: true
          authorizer: jwtAuthorizer

  getUserById:
    handler: src/handlers/user.getUserById
    iamRoleStatements:
      - Effect: Allow
        Action:
          - dynamodb:GetItem
        Resource: !GetAtt UsersTable.Arn
    events:
      - httpApi:
          path: /users/{userId}
          method: get
          cors: true
          authorizer: jwtAuthorizer

  getUserByUsername:
    handler: src/handlers/user.getUserByUsername
    iamRoleStatements:
      - Effect: Allow
        Action:
          - dynamodb:Query
        Resource:
          - !GetAtt UsersTable.Arn
          - !Sub '${UsersTable.Arn}/index/usernameIndex'
    events:
      - httpApi:
          path: /users/username/{username}
          method: get
          cors: true
          authorizer: jwtAuthorizer

  updateUser:
    handler: src/handlers/user.updateUser
    iamRoleStatements:
      - Effect: Allow
        Action:
          - dynamodb:UpdateItem
          - dynamodb:GetItem
          - dynamodb:Query
        Resource:
          - !GetAtt UsersTable.Arn
          - !Sub '${UsersTable.Arn}/index/usernameIndex'
    events:
      - httpApi:
          path: /users/{userId}
          method: put
          cors: true
          authorizer: jwtAuthorizer

  deleteUser:
    handler: src/handlers/user.deleteUser
    iamRoleStatements:
      - Effect: Allow
        Action:
          - dynamodb:DeleteItem
          - dynamodb:GetItem
        Resource: !GetAtt UsersTable.Arn
    events:
      - httpApi:
          path: /users/{userId}
          method: delete
          cors: true
          authorizer: jwtAuthorizer

  listUsers:
    handler: src/handlers/user.listUsers
    iamRoleStatements:
      - Effect: Allow
        Action:
          - dynamodb:Scan
        Resource: !GetAtt UsersTable.Arn
    events:
      - httpApi:
          path: /users
          method: get
          cors: true
          authorizer: jwtAuthorizer

  incrementUserView:
    handler: src/handlers/user.incrementUserView
    iamRoleStatements:
      - Effect: Allow
        Action:
          - dynamodb:UpdateItem
        Resource: !GetAtt UsersTable.Arn
    events:
      - httpApi:
          path: /users/{userId}/view
          method: put
          cors: true
          authorizer: jwtAuthorizer

  addWorkExperience:
    handler: src/handlers/user.addWorkExperience
    iamRoleStatements:
      - Effect: Allow
        Action:
          - dynamodb:UpdateItem
          - dynamodb:GetItem
        Resource: !GetAtt UsersTable.Arn
    events:
      - httpApi:
          path: /users/{userId}/work-experience
          method: post
          cors: true
          authorizer: jwtAuthorizer

  addPortfolioItem:
    handler: src/handlers/user.addPortfolioItem
    iamRoleStatements:
      - Effect: Allow
        Action:
          - dynamodb:UpdateItem
          - dynamodb:GetItem
        Resource: !GetAtt UsersTable.Arn
    events:
      - httpApi:
          path: /users/{userId}/portfolio
          method: post
          cors: true
          authorizer: jwtAuthorizer

  addConnection:
    handler: src/handlers/user.addConnection
    iamRoleStatements:
      - Effect: Allow
        Action:
          - dynamodb:UpdateItem
          - dynamodb:GetItem
        Resource: !GetAtt UsersTable.Arn
    events:
      - httpApi:
          path: /users/{userId}/connections
          method: post
          cors: true
          authorizer: jwtAuthorizer

  searchUsers:
    handler: src/handlers/user.searchUsers
    iamRoleStatements:
      - Effect: Allow
        Action:
          - dynamodb:Scan
        Resource: !GetAtt UsersTable.Arn
    events:
      - httpApi:
          path: /users/search
          method: get
          cors: true
          authorizer: jwtAuthorizer

  createJob:
    handler: src/handlers/casting.createJob
    iamRoleStatements:
      - Effect: Allow
        Action:
          - dynamodb:PutItem
        Resource: !GetAtt CastingTable.Arn
    events:
      - httpApi:
          path: /casting
          method: post
          cors: true

  getJobById:
    handler: src/handlers/casting.getJobById
    iamRoleStatements:
      - Effect: Allow
        Action:
          - dynamodb:GetItem
        Resource: !GetAtt CastingTable.Arn
    events:
      - httpApi:
          path: /casting/{jobId}
          method: get
          cors: true

  listJobs:
    handler: src/handlers/casting.listJobs
    iamRoleStatements:
      - Effect: Allow
        Action:
          - dynamodb:Scan
        Resource: !GetAtt CastingTable.Arn
    events:
      - httpApi:
          path: /casting
          method: get
          cors: true

  updateJob:
    handler: src/handlers/casting.updateJob
    iamRoleStatements:
      - Effect: Allow
        Action:
          - dynamodb:UpdateItem
          - dynamodb:GetItem
        Resource: !GetAtt CastingTable.Arn
    events:
      - httpApi:
          path: /casting/{jobId}
          method: put
          cors: true

  deleteJob:
    handler: src/handlers/casting.deleteJob
    iamRoleStatements:
      - Effect: Allow
        Action:
          - dynamodb:DeleteItem
          - dynamodb:GetItem
        Resource: !GetAtt CastingTable.Arn
    events:
      - httpApi:
          path: /casting/{jobId}
          method: delete
          cors: true

  applyForJob:
    handler: src/handlers/casting.applyForJob
    iamRoleStatements:
      - Effect: Allow
        Action:
          - dynamodb:UpdateItem
          - dynamodb:GetItem
        Resource: !GetAtt CastingTable.Arn
    events:
      - httpApi:
          path: /casting/{jobId}/apply
          method: post
          cors: true

  getJobApplications:
    handler: src/handlers/casting.getJobApplications
    iamRoleStatements:
      - Effect: Allow
        Action:
          - dynamodb:GetItem
        Resource: !GetAtt CastingTable.Arn
    events:
      - httpApi:
          path: /casting/{jobId}/applications
          method: get
          cors: true

  updateApplicationStatus:
    handler: src/handlers/casting.updateApplicationStatus
    iamRoleStatements:
      - Effect: Allow
        Action:
          - dynamodb:UpdateItem
          - dynamodb:GetItem
        Resource: !GetAtt CastingTable.Arn
    events:
      - httpApi:
          path: /casting/{jobId}/applications/{userId}
          method: put
          cors: true

  incrementJobView:
    handler: src/handlers/casting.incrementJobView
    iamRoleStatements:
      - Effect: Allow
        Action:
          - dynamodb:UpdateItem
        Resource: !GetAtt CastingTable.Arn
    events:
      - httpApi:
          path: /casting/{jobId}/view
          method: put
          cors: true

  addDocument:
    handler: src/handlers/casting.addDocument
    iamRoleStatements:
      - Effect: Allow
        Action:
          - dynamodb:UpdateItem
          - dynamodb:GetItem
        Resource: !GetAtt CastingTable.Arn
    events:
      - httpApi:
          path: /casting/{jobId}/documents
          method: post
          cors: true

  removeDocument:
    handler: src/handlers/casting.removeDocument
    iamRoleStatements:
      - Effect: Allow
        Action:
          - dynamodb:UpdateItem
          - dynamodb:GetItem
        Resource: !GetAtt CastingTable.Arn
    events:
      - httpApi:
          path: /casting/{jobId}/documents/{docId}
          method: delete
          cors: true

  getUserApplications:
    handler: src/handlers/casting.getUserApplications
    iamRoleStatements:
      - Effect: Allow
        Action:
          - dynamodb:Scan
        Resource: !GetAtt CastingTable.Arn
    events:
      - httpApi:
          path: /casting/user/{userId}/applications
          method: get
          cors: true

  searchJobs:
    handler: src/handlers/casting.searchJobs
    iamRoleStatements:
      - Effect: Allow
        Action:
          - dynamodb:Scan
        Resource: !GetAtt CastingTable.Arn
    events:
      - httpApi:
          path: /casting/search
          method: get
          cors: true

resources:
  Resources:
    UsersTable:
      ${file(resources/DynamoTable.yaml):UsersTable}
    CastingTable:
      ${file(resources/DynamoTable.yaml):CastingTable}
    CognitoUserPool: 
      ${file(resources/Cognito.yaml):CognitoUserPool}
    CognitoUserPoolClient: 
      ${file(resources/Cognito.yaml):CognitoUserPoolClient}
    CognitoUserPoolDomain: 
      ${file(resources/Cognito.yaml):CognitoUserPoolDomain}
plugins:
  - serverless-iam-roles-per-function

custom:
  cognito:
    userPoolId: !Ref CognitoUserPool
    userPoolClientId: !Ref CognitoUserPoolClient